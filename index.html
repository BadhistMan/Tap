<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tapswap Enhanced</title>
    <!-- Telegram WebApp JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* [Keep all your existing CSS styles] */
        /* Only adding new styles for notifications */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background: #34c759;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.error {
            background: #ff3b30;
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="loadingOverlay">Loading...</div>
        <div class="notification" id="notification"></div>

        <div id="content">
            <!-- Profile Page -->
            <div id="profilePage" class="page">
                <div class="card">
                    <h2>Profile</h2>
                    <img id="profilePic" class="profile-pic" alt="Profile Picture">
                    <div class="info-item">
                        <span>Name:</span>
                        <span id="profileName">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span>User ID:</span>
                        <span id="profileUserId">Loading...</span>
                    </div>
                    <div class="info-item">
                        <span>Taps:</span>
                        <span id="profilePoints">0</span>
                    </div>
                    <div class="info-item">
                        <span>Referrals:</span>
                        <span id="profileReferrals">0</span>
                    </div>
                    <div class="info-item">
                        <span>Energy:</span>
                        <span id="profileEnergy">100%</span>
                    </div>
                    <div class="info-item">
                        <span>Referral Link:</span>
                        <span id="profileReferral">N/A</span>
                    </div>
                </div>
            </div>

            <!-- Tap Page -->
            <div id="tapPage" class="page active">
                <div class="score-display">
                    <span class="score-icon"></span>
                    <span id="pointsDisplay">0</span>
                </div>
                <div class="tap-area">
                    <button id="catButton">
                        <div id="catImage">TAP</div>
                    </button>
                </div>
                <div class="energy-section">
                    <div class="energy-label">
                        <span>âš¡ Energy</span>
                        <span id="energyLevel">100 / 100</span>
                    </div>
                    <div class="energy-bar-container">
                        <div id="energyBar"></div>
                    </div>
                </div>
            </div>

            <!-- Task Page (Removed) -->
            
            <!-- Withdraw Page -->
            <div id="withdrawPage" class="page">
                <div class="card">
                    <h2>Withdraw Taps</h2>
                    <p style="text-align: center; color: var(--secondary-color); font-size: 0.95em; margin-bottom: 25px;">
                        Available: <strong id="withdrawPointsAvailable" style="color: var(--text-color); font-weight: 600;">0</strong>
                    </p>

                    <div class="form-group">
                        <label for="withdrawAmount">Amount:</label>
                        <input type="number" id="withdrawAmount" placeholder="Enter taps to withdraw" min="1">
                    </div>

                    <div class="form-group">
                        <label for="withdrawMethod">Method:</label>
                        <select id="withdrawMethod">
                            <option value="crypto">Crypto (USDT)</option>
                            <option value="paypal">PayPal</option>
                        </select>
                    </div>

                    <div id="methodDetails">
                        <div class="form-group detail-field crypto-field">
                            <label for="cryptoAddress">USDT Wallet Address (TRC20):</label>
                            <input type="text" id="cryptoAddress" placeholder="T...">
                        </div>
                        <div class="form-group detail-field paypal-field" style="display: none;">
                            <label for="paypalEmail">PayPal Email:</label>
                            <input type="email" id="paypalEmail" placeholder="your.email@example.com">
                        </div>
                    </div>

                    <button id="submitWithdrawal" class="withdraw-button">Request Withdrawal</button>
                    <p id="withdrawMessage" class="withdraw-message"></p>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation Bar -->
        <nav id="bottomNav">
            <button class="nav-button" data-page="profilePage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Profile
            </button>
            <button class="nav-button active" data-page="tapPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.92 2.75a.75.75 0 0 1 .58.2l7.5 7.5a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 1 1-1.06-1.06l3.72-3.72-7.44-7.44A.75.75 0 0 1 11.92 2.75zM3.81 9.28a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 1 1 1.06 1.06L5.4 8.75l7.44 7.44a.75.75 0 0 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1-.47-.77z"/></svg>
                Tap
            </button>
            <button class="nav-button" id="referralBtn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                Referral
            </button>
            <button class="nav-button" data-page="withdrawPage">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm0-12H4V6h16v2zm-4 8H8v-2h8v2z"/></svg>
                Withdraw
            </button>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE_URL = 'https://coin-tap-game.onrender.com'; // Your Render URL
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const notificationEl = document.getElementById('notification');
        const content = document.getElementById('content');
        const pages = document.querySelectorAll('.page');
        const navButtons = document.querySelectorAll('.nav-button');
        const pointsDisplay = document.getElementById('pointsDisplay');
        const profilePoints = document.getElementById('profilePoints');
        const profileReferrals = document.getElementById('profileReferrals');
        const profileEnergy = document.getElementById('profileEnergy');
        const withdrawPointsAvailable = document.getElementById('withdrawPointsAvailable');
        const catButton = document.getElementById('catButton');
        const catImage = document.getElementById('catImage');
        const energyLevelDisplay = document.getElementById('energyLevel');
        const energyBar = document.getElementById('energyBar');
        const profileName = document.getElementById('profileName');
        const profileUserId = document.getElementById('profileUserId');
        const profileJoinDate = document.getElementById('profileJoinDate');
        const profileReferral = document.getElementById('profileReferral');
        const profilePic = document.getElementById('profilePic');
        const withdrawAmountInput = document.getElementById('withdrawAmount');
        const withdrawMethodSelect = document.getElementById('withdrawMethod');
        const submitWithdrawalButton = document.getElementById('submitWithdrawal');
        const withdrawMessage = document.getElementById('withdrawMessage');
        const referralBtn = document.getElementById('referralBtn');
        const cryptoAddressInput = document.getElementById('cryptoAddress');
        const paypalEmailInput = document.getElementById('paypalEmail');

        // Game State
        let userId = null;
        let taps = 0;
        let referrals = 0;
        let energy = 100;
        let lastUpdate = Date.now();

        // --- Initialization ---
        function initApp() {
            console.log("Initializing App...");
            tg.ready();
            applyTheme();
            tg.onEvent('themeChanged', applyTheme);
            tg.expand();

            try {
                tg.disableVerticalSwipes();
            } catch (e) {
                console.warn("disableVerticalSwipes not supported:", e.message);
            }

            initUser();
            setupEventListeners();

            // Hide loading overlay
            setTimeout(() => {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => {
                    loadingOverlay.style.display = 'none';
                }, 300);
            }, 500);

            console.log("App Initialized.");
        }

        // Initialize user
        function initUser() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                userId = tg.initDataUnsafe.user.id.toString();
                profileName.textContent = `${tg.initDataUnsafe.user.first_name || ''} ${tg.initDataUnsafe.user.last_name || ''}`.trim() || 'Telegram User';
                profileUserId.textContent = userId;
                if (tg.initDataUnsafe.user.photo_url) {
                    profilePic.src = tg.initDataUnsafe.user.photo_url;
                }
            } else {
                userId = generateUserId();
                profileName.textContent = "Guest User";
                profileUserId.textContent = userId;
            }
            
            profileJoinDate.textContent = new Date().toLocaleDateString();
            generateReferralLink();
            loadUserData();
            
            // Update energy every minute
            setInterval(updateEnergyFromBackend, 60000);
        }

        // Generate a unique user ID
        function generateUserId() {
            return 'user_' + Math.random().toString(36).substr(2, 9);
        }

        // --- API Functions ---
        async function loadUserData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    taps = data.user.taps;
                    referrals = data.user.referrals;
                    energy = data.user.energy;
                    
                    updateUI();
                } else if (data.status === 'user_not_found') {
                    await createUser();
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Failed to load data', 'error');
            }
        }

        async function createUser() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/${userId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.status === 'success') {
                    taps = data.taps || 0;
                    energy = data.energy || 100;
                    updateUI();
                }
            } catch (error) {
                console.error('Error creating user:', error);
                showNotification('Failed to create user', 'error');
            }
        }

        async function handleTap() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    taps = data.taps;
                    energy = data.new_energy;
                    updateUI();
                    showNotification('+1 tap!');
                    
                    // Haptic feedback
                    try { 
                        tg.HapticFeedback.impactOccurred('light'); 
                    } catch(e) {}
                    
                } else if (data.status === 'energy_low') {
                    energy = data.energy;
                    updateUI();
                    showNotification('Low energy!', 'error');
                    
                    // Haptic feedback for error
                    try { 
                        tg.HapticFeedback.notificationOccurred('error'); 
                    } catch(e) {}
                }
            } catch (error) {
                console.error('Error processing tap:', error);
                showNotification('Tap failed. Try again!', 'error');
            }
        }

        async function applyReferral(referrerId) {
            if (!referrerId || referrerId === userId) {
                showNotification("Invalid referral code", "error");
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/referral`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        referrer_id: referrerId
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification('Referral applied! +50 taps');
                    await loadUserData(); // Refresh data
                } else {
                    showNotification(data.status || "Referral failed", "error");
                }
            } catch (error) {
                console.error('Referral error:', error);
                showNotification('Referral failed', 'error');
            }
        }

        async function handleWithdraw() {
            const amount = parseInt(withdrawAmountInput.value);
            const method = withdrawMethodSelect.value;
            const address = method === 'crypto' ? cryptoAddressInput.value : paypalEmailInput.value;
            
            if (!amount || amount < 1) {
                showNotification('Invalid amount', 'error');
                return;
            }
            
            if (!address) {
                showNotification(`Enter ${method === 'crypto' ? 'wallet address' : 'email'}`, 'error');
                return;
            }
            
            if (amount > taps) {
                showNotification('Insufficient taps', 'error');
                return;
            }
            
            submitWithdrawalButton.disabled = true;
            submitWithdrawalButton.textContent = 'Processing...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        amount: amount,
                        method: method,
                        address: address
                    })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showNotification(`Withdrawal request for ${amount} taps submitted!`);
                    taps -= amount;
                    updateUI();
                    
                    // Clear form
                    withdrawAmountInput.value = '';
                    cryptoAddressInput.value = '';
                    paypalEmailInput.value = '';
                } else {
                    showNotification(data.message || 'Withdrawal failed', 'error');
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                showNotification('Withdrawal failed', 'error');
            } finally {
                submitWithdrawalButton.disabled = false;
                submitWithdrawalButton.textContent = 'Request Withdrawal';
            }
        }

        async function updateEnergyFromBackend() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/user/${userId}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    energy = data.user.energy;
                    updateEnergyDisplay();
                }
            } catch (error) {
                console.error('Error updating energy:', error);
            }
        }

        // --- UI Functions ---
        function updateUI() {
            pointsDisplay.textContent = taps.toLocaleString();
            profilePoints.textContent = taps.toLocaleString();
            withdrawPointsAvailable.textContent = taps.toLocaleString();
            profileReferrals.textContent = referrals.toLocaleString();
            updateEnergyDisplay();
        }

        function updateEnergyDisplay() {
            energyLevelDisplay.textContent = `${Math.round(energy)}%`;
            energyBar.style.width = `${energy}%`;
            profileEnergy.textContent = `${Math.round(energy)}%`;
        }

        function generateReferralLink() {
            if (userId) {
                const link = `${window.location.origin}?ref=${userId}`;
                profileReferral.textContent = link;
                profileReferral.style.cursor = 'pointer';
                profileReferral.style.color = 'var(--tg-theme-link-color, var(--fallback-link-color))';
                profileReferral.onclick = () => {
                    navigator.clipboard.writeText(link);
                    showNotification('Referral link copied!');
                };
            }
        }

        function applyTheme() {
            const themeParams = tg.themeParams || {};
            const root = document.documentElement.style;
            
            const setVar = (varName, tgValue, fallbackValue) => {
                root.setProperty(varName, tgValue || fallbackValue);
            };

            setVar('--primary-color', themeParams.button_color, '#4a6bff');
            setVar('--secondary-color', themeParams.hint_color, '#6c757d');
            setVar('--background-color', themeParams.bg_color, '#f7f8fa');
            setVar('--text-color', themeParams.text_color, '#1c1e21');
            setVar('--card-bg', themeParams.secondary_bg_color, '#ffffff');

            const isDark = tg.colorScheme === 'dark' || 
                          (themeParams.bg_color && isColorDark(themeParams.bg_color));
            document.body.classList.toggle('dark', isDark);
        }

        function isColorDark(hexColor) {
            if (!hexColor) return false;
            try {
                hexColor = hexColor.replace(/^#/, '');
                if (hexColor.length === 3) hexColor = hexColor.split('').map(char => char + char).join('');
                const r = parseInt(hexColor.substring(0, 2), 16);
                const g = parseInt(hexColor.substring(2, 4), 16);
                const b = parseInt(hexColor.substring(4, 6), 16);
                const luminance = (0.2126 * r + 0.7152 * g + 0.0722 * b) / 255;
                return luminance < 0.5;
            } catch (e) { return false; }
        }

        function showPage(pageId) {
            pages.forEach(page => {
                page.classList.toggle('active', page.id === pageId);
            });

            navButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.page === pageId);
            });

            if (pageId === 'withdrawPage') {
                withdrawAmountInput.max = taps;
            }
        }

        function showNotification(message, type = 'success') {
            notificationEl.textContent = message;
            notificationEl.className = `notification ${type === 'error' ? 'error' : ''} show`;
            
            setTimeout(() => {
                notificationEl.className = 'notification';
            }, 3000);
        }

        function updateWithdrawMethodDetails() {
            const method = withdrawMethodSelect.value;
            document.querySelectorAll('.detail-field').forEach(field => {
                field.style.display = field.classList.contains(`${method}-field`) ? 'block' : 'none';
            });
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // Navigation
            navButtons.forEach(button => {
                if (button.dataset.page) {
                    button.addEventListener('click', () => showPage(button.dataset.page));
                }
            });
            
            // Referral button
            referralBtn.addEventListener('click', () => {
                const referrerId = prompt("Enter your friend's referral code:");
                if (referrerId) {
                    applyReferral(referrerId);
                }
            });

            // Tapping
            catButton.addEventListener('click', handleTap);

            // Withdrawal form
            withdrawMethodSelect.addEventListener('change', updateWithdrawMethodDetails);
            submitWithdrawalButton.addEventListener('click', handleWithdraw);
            
            // Handle referral parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode && refCode !== userId) {
                applyReferral(refCode);
            }
        }

        // --- Start the App ---
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
                </html>
